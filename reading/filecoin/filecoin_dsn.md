### 4. Filecoin: a DSN Construction

- DSN: decentralized storage network, 去中心化存储网络

- 可审核, 可公开校验, 具备激励机制
- 客户为数据的存储和提取行为向矿工付费
- 矿工通过向网络证明自己的服务正确性来获取酬劳



#### 4.1 准备

##### 4.1.1 参与者

- 客户: 为数据的存储和提取行为付费
- 存储矿工: 向网络提供磁盘空间并响应 Put 请求
  - 为自己的存储提供抵押物
  - 通过承诺持续保存客户数据来响应 Put 请求
  - 通过生成 PoSt 并提交到区块链上来向网络提供证明
  - 作为惩罚, 非法的或缺失的证明会导致抵押物的损失
  - 同时具备挖掘新区块的资格
  - 区块的挖掘者会获得创建区块的奖励以及该区块中交易的手续费
- 数据提取矿工
  - 向网络提供数据提取服务
  - 响应客户的 Get 请求
  - 不必提供抵押, 存储承诺或提供存储证明
  - 存储矿工常常也扮演数据提取矿工的角色
  - 直接从客户, 或从数据市场获取酬劳

##### 4.1.2 网络 (The Network)

- 将所有运行 FIlecoin 全节点的用户拟人化为一个抽象实体: 网络 (*The Network*)
- 网络扮演运行 Manage 协议的中间人
- 在 Filecoin 链上的每个区块中, 全节点管理可用空间, 检查抵押物, 审核存储证明, 并修复可能的异常



##### 4.1.3 账本 (The Ledger)

- 协议构建在基于账本的货币之上
- 概括为 *Ledger* , $L$
- 在任意时刻 t, 用户可以访问 $L_t$: 一组有序的交易记录
- 账本记录只追加
- Filecoin DSN 协议可以基于任何能提供 Filecoin 的证明校验的账本



##### 4.1.4 市场 (The Markets)

- 存储市场和提取市场分别满足存储的需求和供应
- 两个市场都是去中心化的交易所
- 客户和矿工通过向市场提交订单来给自己需求或提供的服务定价
- 交易所撮合出价匹配的客户和矿工并开始交易
- 网络通过运行 Manage 协议, 保证在服务成功的情况下, 矿工得到奖励, 客户需求得到满足



#### 4.2 数据结构

- **Pieces**: 客户存储在 DSN 中的数据片
- **Sectors**: 存储矿工提供的磁盘空间
- **AllocationTable**: pieces 和 sectors 的关联关系表
  - 每个区块都会被更新
  - Merkel root 保存在最新的区块中
  - 实践中, 将 DSN 的状态保存在表中, 以便在证明校验过程中快速检索
- **Orders**: 是请求或提供服务的申明
  - *bid* 订单用于客户请求服务
  - 矿工提交 *ask* 订单来提供服务
- **Orderbook**: 订单集合
- **Pledge**: 向网络提供存储的担保.
  - 存储矿工必须先向账本提交担保才能开始接受订单
  - 担保中必须包含 sector 的数量, 以及适当的抵押物



#### 4.3 协议

通过对客户, 矿工, 网络的操作的描述来展示 Filecoin DSN 的概览



##### 4.3.1 客户循环

1. Put: 客户在 Filecoin 上存储数据

   - 始于向存储市场提交 bid 订单
   - 与 ask 订单匹配成功后, 发送 piece 给矿工
   - 交易成功后双方形成 deal 订单发送给存储市场
   - 客户可以通过提交多份订单或在订单中指定副本因子来确定所需的物理副本数量

   

2. Get: 客户从 Filecoin 提取数据

   - 始于向提取市场提交 bid 订单
   - 与 ask 订单匹配成功后, 获取来自矿工的 piece
   - 成功后生成 deal 订单



##### 4.3.2 存储挖矿循环

一个简易的概览:

1. Pledge: 矿工向网络提交存储担保

   - 通过链上的 *pledge* 交易, 经由 Manage.PledgeSector 向网络提交抵押物
   - 抵押物在提供服务前提交, 在数据存储得到证明后归还
   - 存储证明失败和导致抵押物的损失
   - 当 pledge 交易出现在链上之后, 矿工可以向市场提交定价和 ask 订单, 即开始提供存储服务

2. Receive Orders: 矿工从市场得到存储请求

   - 通过 Put.AddOrders 提交定价和 ask 订单
   - 通过 Put.MatchOrders 来检查匹配的 bid 订单
   - 通过 Put.ReceivePiece 获取数据
   - 数据获取成功后, 双方共同签署 deal 订单并提交到链上

3. Seal: 矿工为将来的证明准备数据

   - 存储被划分为 sector

   - sector 内存储分配给矿工的 pieces

   - 网络通过 AllocationTable 追踪 sector

   - 当 sector 占满后, 被标记为 sealed

   - Sealing 将数据转化为副本, 是一个缓慢, 顺序进行的操作.

     副本是一个在物理层面独立的数据拷贝, 与矿工的公钥有关

   - Sealing 是 PoRep 中的必要操作

4. Prove: 矿工为他们承诺存储的 pieces 提供证明

   - 反复生成数据副本的证明来确保数据的存在
   - 向链上提交证明, 并由网络进行校验



##### 4.3.3 数据提取挖矿循环

